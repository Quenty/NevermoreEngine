"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[81027],{40175:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"testing/testing","title":"Test Infrastructure","description":"Writing tests","source":"@site/docs/testing/testing.md","sourceDirName":"testing","slug":"/testing/","permalink":"/NevermoreEngine/docs/testing/","draft":false,"unlisted":false,"editUrl":"https://github.com/Quenty/NevermoreEngine/edit/main/docs/testing/testing.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Test Infrastructure","sidebar_position":1},"sidebar":"defaultSidebar","previous":{"title":"Testing","permalink":"/NevermoreEngine/docs/testing/"},"next":{"title":"Conventions","permalink":"/NevermoreEngine/docs/conventions/"}}');var r=n(74848),i=n(28453);const l={title:"Test Infrastructure",sidebar_position:1},c="Testing",o={},d=[{value:"Writing tests",id:"writing-tests",level:2},{value:"Example test",id:"example-test",level:3},{value:"Setting up a package for testing",id:"setting-up-a-package-for-testing",level:2},{value:"1. deploy.nevermore.json",id:"1-deploynevermorejson",level:3},{value:"2. Rojo project (test/default.project.json)",id:"2-rojo-project-testdefaultprojectjson",level:3},{value:"3. Script template (test/scripts/Server/ServerMain.server.lua)",id:"3-script-template-testscriptsserverservermainserverlua",level:3},{value:"NevermoreTestRunnerUtils",id:"nevermoretestrunnerutils",level:3},{value:"Running tests",id:"running-tests",level:2},{value:"Single package",id:"single-package",level:3},{value:"Batch testing",id:"batch-testing",level:3},{value:"Credential resolution",id:"credential-resolution",level:2},{value:"Failure annotations",id:"failure-annotations",level:2},{value:"CI design principles",id:"ci-design-principles",level:2}];function a(e){const s={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"testing",children:"Testing"})}),"\n",(0,r.jsx)(s.h2,{id:"writing-tests",children:"Writing tests"}),"\n",(0,r.jsxs)(s.p,{children:["We use ",(0,r.jsx)(s.a,{href:"https://github.com/jsdotlua/jest-lua",children:"Jest3"})," via the Nevermore-compatible wrapper ",(0,r.jsx)(s.code,{children:"@quentystudios/jest-lua"}),". The only difference from upstream Jest is how you access globals \u2014 require ",(0,r.jsx)(s.code,{children:"Jest"})," and access them via ",(0,r.jsx)(s.code,{children:"Jest.Globals"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["Test files must end in ",(0,r.jsx)(s.code,{children:".spec.lua"})," and live alongside the code they test (e.g. ",(0,r.jsx)(s.code,{children:"src/Shared/MyUtils.spec.lua"}),")."]}),"\n",(0,r.jsx)(s.h3,{id:"example-test",children:"Example test"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-luau",children:'--!nonstrict\n--[[\n\t@class MyUtils.spec.lua\n]]\n\nlocal require = (require :: any)(\n\t\tgame:GetService("ServerScriptService"):FindFirstChild("LoaderUtils", true).Parent\n\t).bootstrapStory(script) :: typeof(require(script.Parent.loader).load(script))\n\nlocal Jest = require("Jest")\nlocal MyUtils = require("MyUtils")\n\nlocal describe = Jest.Globals.describe\nlocal expect = Jest.Globals.expect\nlocal it = Jest.Globals.it\n\ndescribe("MyUtils", function()\n\tit("should do something", function()\n\t\texpect(MyUtils.doSomething()).toBe(true)\n\tend)\nend)\n'})}),"\n",(0,r.jsx)(s.h2,{id:"setting-up-a-package-for-testing",children:"Setting up a package for testing"}),"\n",(0,r.jsx)(s.p,{children:"Each testable package needs:"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsxs)(s.strong,{children:["A ",(0,r.jsx)(s.code,{children:"deploy.nevermore.json"})]})," with a ",(0,r.jsx)(s.code,{children:"test"})," target"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"A Rojo project file"})," (typically ",(0,r.jsx)(s.code,{children:"test/default.project.json"}),") that builds the test place"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"A script template"})," (typically ",(0,r.jsx)(s.code,{children:"test/scripts/Server/ServerMain.server.lua"}),") that boots the package and runs tests"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"1-deploynevermorejson",children:"1. deploy.nevermore.json"}),"\n",(0,r.jsxs)(s.p,{children:["Run ",(0,r.jsx)(s.code,{children:"nevermore deploy init"})," from inside a package directory. The interactive wizard will walk you through setting up the test target, or use flags for non-interactive setup:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# Interactive (recommended for first time)\nnevermore deploy init\n\n# Non-interactive\nnevermore deploy init --yes --universe-id 12345 --create-place --project test/default.project.json --script-template test/scripts/Server/ServerMain.server.lua\n"})}),"\n",(0,r.jsx)(s.p,{children:"The resulting config looks like:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'{\n  "targets": {\n    "test": {\n      "universeId": 12345,\n      "placeId": 67890,\n      "project": "test/default.project.json",\n      "scriptTemplate": "test/scripts/Server/ServerMain.server.lua"\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"2-rojo-project-testdefaultprojectjson",children:"2. Rojo project (test/default.project.json)"}),"\n",(0,r.jsxs)(s.p,{children:["The test project maps the package into ",(0,r.jsx)(s.code,{children:"ServerScriptService"})," so the test runner can find it:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'{\n  "name": "MyPackageTest",\n  "tree": {\n    "$className": "DataModel",\n    "ServerScriptService": {\n      "$properties": {\n        "LoadStringEnabled": true\n      },\n      "mypackage": {\n        "$path": ".."\n      },\n      "Script": {\n        "$path": "scripts/Server"\n      }\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(s.h3,{id:"3-script-template-testscriptsserverservermainserverlua",children:"3. Script template (test/scripts/Server/ServerMain.server.lua)"}),"\n",(0,r.jsxs)(s.p,{children:["The script template is executed via Open Cloud (or locally via studio-bridge). It bootstraps the loader and delegates to ",(0,r.jsx)(s.code,{children:"NevermoreTestRunnerUtils"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-luau",children:'--!nonstrict\n--[[\n\t@class ServerMain\n]]\n\nlocal ServerScriptService = game:GetService("ServerScriptService")\n\nlocal loader = ServerScriptService:FindFirstChild("LoaderUtils", true).Parent\nlocal require = require(loader).bootstrapGame(ServerScriptService.mypackage)\n\nlocal NevermoreTestRunnerUtils = require("NevermoreTestRunnerUtils")\n\nNevermoreTestRunnerUtils.runTestsIfNeededAsync(ServerScriptService.mypackage)\n'})}),"\n",(0,r.jsxs)(s.p,{children:["Replace ",(0,r.jsx)(s.code,{children:"mypackage"})," with the key used in your Rojo project tree."]}),"\n",(0,r.jsx)(s.h3,{id:"nevermoretestrunnerutils",children:"NevermoreTestRunnerUtils"}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"@quenty/nevermore-test-runner"})," package provides ",(0,r.jsx)(s.code,{children:"NevermoreTestRunnerUtils"}),", which handles the test execution lifecycle:"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["If a ",(0,r.jsx)(s.code,{children:"jest.config"})," is found under the given root, it runs Jest tests"]}),"\n",(0,r.jsxs)(s.li,{children:["If no ",(0,r.jsx)(s.code,{children:"jest.config"})," is found, boot success is the test (smoke test)"]}),"\n",(0,r.jsx)(s.li,{children:"Detects Open Cloud vs local execution context and exits appropriately"}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"running-tests",children:"Running tests"}),"\n",(0,r.jsx)(s.h3,{id:"single-package",children:"Single package"}),"\n",(0,r.jsxs)(s.p,{children:["From a package directory with a ",(0,r.jsx)(s.code,{children:"deploy.nevermore.json"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# Run locally via studio-bridge (default)\nnevermore test\n\n# Run via Roblox Open Cloud\nnevermore test --cloud\n\n# Show execution logs\nnevermore test --logs\n"})}),"\n",(0,r.jsx)(s.p,{children:"Options:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--cloud"})}),(0,r.jsx)(s.td,{children:"Run tests via Open Cloud instead of locally"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--logs"})}),(0,r.jsx)(s.td,{children:"Show execution logs"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--api-key"})}),(0,r.jsxs)(s.td,{children:["Roblox Open Cloud API key (",(0,r.jsx)(s.code,{children:"--cloud"})," only)"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--universe-id"})}),(0,r.jsx)(s.td,{children:"Override universe ID from deploy.nevermore.json"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--place-id"})}),(0,r.jsx)(s.td,{children:"Override place ID from deploy.nevermore.json"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--script-template"})}),(0,r.jsx)(s.td,{children:"Override script template path"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--script-text"})}),(0,r.jsx)(s.td,{children:"Luau code to execute directly instead of the configured template"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"batch-testing",children:"Batch testing"}),"\n",(0,r.jsx)(s.p,{children:"Run tests across multiple packages, with automatic change detection:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"# Test only packages changed vs origin/main\nnevermore batch test\n\n# Test all packages with test targets\nnevermore batch test --all\n\n# Run via Open Cloud with concurrency\nnevermore batch test --cloud --concurrency 3\n\n# Write JSON results to file\nnevermore batch test --output results.json\n"})}),"\n",(0,r.jsx)(s.p,{children:"Options:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Flag"}),(0,r.jsx)(s.th,{children:"Description"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--cloud"})}),(0,r.jsx)(s.td,{children:"Run tests via Open Cloud instead of locally"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--all"})}),(0,r.jsx)(s.td,{children:"Test all packages, not just changed ones"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--base"})}),(0,r.jsxs)(s.td,{children:["Git ref to diff against (default: ",(0,r.jsx)(s.code,{children:"origin/main"}),")"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--concurrency"})}),(0,r.jsx)(s.td,{children:"Max parallel tests (default: 1 local, 3 cloud)"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--output"})}),(0,r.jsx)(s.td,{children:"Write JSON results to a file"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--limit"})}),(0,r.jsx)(s.td,{children:"Max number of packages to test"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"--logs"})}),(0,r.jsx)(s.td,{children:"Show execution logs for all packages"})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"credential-resolution",children:"Credential resolution"}),"\n",(0,r.jsx)(s.p,{children:"The CLI resolves API credentials in this order (first match wins):"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"--api-key"})," CLI flag"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ROBLOX_OPEN_CLOUD_API_KEY"})," environment variable"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"ROBLOX_UNIT_TEST_API_KEY"})," environment variable (backwards compat)"]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.code,{children:"~/.nevermore/credentials.json"})," (stored via ",(0,r.jsx)(s.code,{children:"nevermore login"}),")"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["In interactive mode, if no credentials are found, the CLI prompts inline. In ",(0,r.jsx)(s.code,{children:"--yes"})," (CI) mode, it errors immediately."]}),"\n",(0,r.jsx)(s.h2,{id:"failure-annotations",children:"Failure annotations"}),"\n",(0,r.jsxs)(s.p,{children:["When tests fail in CI, the ",(0,r.jsx)(s.code,{children:"post-test-results"})," command parses Jest-lua output and emits GitHub Actions annotations pointing to the failing spec files. To map Roblox instance paths (e.g. ",(0,r.jsx)(s.code,{children:"ServerScriptService.maid.Shared.Maid.spec"}),") back to repo-relative filesystem paths, two strategies are used:"]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Sourcemap resolution"})," (preferred) \u2014 If ",(0,r.jsx)(s.code,{children:"sourcemap.json"})," exists (generated by ",(0,r.jsx)(s.code,{children:"rojo sourcemap --absolute"}),"), the ",(0,r.jsx)(s.code,{children:"SourcemapResolver"})," builds a lookup index from the tree. This is exact and handles all project layouts. The CI workflow runs ",(0,r.jsx)(s.code,{children:"npm run build:sourcemap"})," before posting results to ensure the file is available."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Heuristic fallback"})," \u2014 When no sourcemap is available, the resolver assumes the standard ",(0,r.jsx)(s.code,{children:"src/{slug}/src/"})," layout and rejoins known dotted suffixes (",(0,r.jsx)(s.code,{children:".spec"}),", ",(0,r.jsx)(s.code,{children:".story"}),"). This works for the common case but can produce wrong paths for non-standard layouts or dotted filenames."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["The resolver code lives in ",(0,r.jsx)(s.code,{children:"tools/nevermore-cli/src/utils/sourcemap/"})," and is shared with the ",(0,r.jsx)(s.code,{children:"strip-sourcemap-jest"})," command."]}),"\n",(0,r.jsx)(s.h2,{id:"ci-design-principles",children:"CI design principles"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Workflows should be thin."})," All logic lives in ",(0,r.jsx)(s.code,{children:"nevermore-cli"})," commands \u2014 GitHub Actions workflows just call them. This keeps CI debuggable locally."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Rate limiting"})," is shared across concurrent workers via the ",(0,r.jsx)(s.code,{children:"OpenCloudClient"})," instance. The ",(0,r.jsx)(s.code,{children:"RateLimiter"})," serializes all Open Cloud API requests (one in-flight at a time) and reads ",(0,r.jsx)(s.code,{children:"x-ratelimit-remaining"})," / ",(0,r.jsx)(s.code,{children:"x-ratelimit-reset"})," headers."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Post results via CLI"}),": ",(0,r.jsx)(s.code,{children:"nevermore tools post-test-results <file>"})," posts or updates a PR comment with test results and writes to the GitHub Actions job summary. Requires ",(0,r.jsx)(s.code,{children:"GITHUB_TOKEN"})," for PR comments; job summaries are written automatically when ",(0,r.jsx)(s.code,{children:"GITHUB_STEP_SUMMARY"})," is set."]}),"\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Job summaries"}),": Results are automatically written to the ",(0,r.jsx)(s.a,{href:"https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-commands#adding-a-job-summary",children:"GitHub Actions job summary"})," when running in CI. This makes results visible on the workflow run summary page, complementing the PR comment."]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>c});var t=n(96540);const r={},i=t.createContext(r);function l(e){const s=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:s},e.children)}}}]);